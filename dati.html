<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>Dati — ShortCode Maker v4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{
      --bg:#0f1115;--panel:#111827;--panel-2:#0f1623;--muted:#98a2b3;
      --text:#e6e6e6;--line:#2a2f3a;--radius:12px;--gap:12px;
    }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;z-index:50;background:#0f131a;border-bottom:1px solid var(--line)}
    .bar{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;align-items:center;gap:14px}
    h1{font-size:18px;margin:0}
    nav{margin-left:auto;display:flex;gap:8px;flex-wrap:wrap}
    nav a{ text-decoration:none;color:#cbd5e1;background:#111827;border:1px solid var(--line);
      padding:6px 10px;border-radius:8px;font-size:14px }
    nav a.active{color:white;border-color:#3b82f6;box-shadow:0 0 0 1px #3b82f6 inset}
    main{max-width:1200px;margin:0 auto;padding:20px}

    .toolbar{display:flex;gap:8px;flex-wrap:wrap;margin-bottom:14px}
    .btn{background:#111827;border:1px solid var(--line);color:#e5e7eb;
      padding:8px 12px;border-radius:10px;font-size:14px;cursor:pointer}
    .btn:hover{border-color:#3b82f6}
    .btn.ok{border-color:#22c55e}
    .btn.danger{border-color:#ef4444;color:#fecaca}
    .btn.ghost{background:transparent}
    .btn.small{padding:6px 9px;font-size:13px}
    .spacer{flex:1}

    .tabs{display:flex;gap:8px;margin:8px 0 16px}
    .tab{ padding:8px 12px;border-radius:10px;background:#111827;border:1px solid var(--line);
      cursor:pointer;user-select:none }
    .tab.active{border-color:#3b82f6;box-shadow:0 0 0 1px #3b82f6 inset}
    .panel{background:#111827;border:1px solid var(--line);border-radius:12px;padding:12px}

    table{width:100%;border-collapse:separate;border-spacing:0 8px}
    thead th{font-weight:600;color:#cbd5e1;text-align:left;font-size:13px;padding:8px 10px}
    tbody td{padding:8px 10px;border-top:1px solid var(--line);border-bottom:1px solid var(--line);
             background:#0f1623}
    tbody tr td:first-child{border-left:1px solid var(--line);border-top-left-radius:10px;border-bottom-left-radius:10px}
    tbody tr td:last-child{border-right:1px solid var(--line);border-top-right-radius:10px;border-bottom-right-radius:10px}
    input[type="text"]{width:100%;background:#0b1220;border:1px solid #233047;color:#e5e7eb;border-radius:8px;padding:8px 10px;font-size:14px}
    input[type="checkbox"]{width:18px;height:18px}
    .row-actions{display:flex;gap:8px}
    .note{color:#98a2b3;font-size:13px;margin-top:6px}
    .grid-actions{display:flex;gap:8px;margin:10px 0}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1220;border:1px solid var(--line);
          padding:8px 10px;border-radius:999px;color:#cbd5e1;font-size:13px}
    .hidden{display:none}
    .footer-note{margin-top:12px;color:#9aa4b2;font-size:12px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <h1>Dati — ShortCode Maker v4</h1>
    <nav>
      <a href="index.html">Generatore</a>
      <a href="istruzioni.html">Istruzioni</a>
      <a class="active" href="dati.html">Dati</a>
      <a href="tipi.html">Config. Tipi</a>
    </nav>
  </div>
</header>

<main>
  <div class="toolbar">
    <button class="btn" onclick="history.back()">← Indietro</button>
    <div class="spacer"></div>
    <button class="btn ok" id="btnSave">Salva</button>
    <button class="btn" id="btnValidate">Valida</button>
    <button class="btn" id="btnReset">Reset default</button>
    <button class="btn" id="btnRemove">Rimuovi override</button>
    <button class="btn" id="btnExport">Esporta JSON</button>
    <label class="btn ghost" for="fileImport">Importa JSON</label>
    <input id="fileImport" type="file" accept="application/json" class="hidden" />
  </div>

  <div class="tabs" id="tabs">
    <div class="tab active" data-tab="famiglie">Famiglie</div>
    <div class="tab" data-tab="materiali">Materiali</div>
    <div class="tab" data-tab="finiture">Finiture</div>
    <div class="tab" data-tab="tipi">Tipi</div>
  </div>

  <!-- Famiglie -->
  <section class="panel" id="view-famiglie">
    <div class="grid-actions">
      <button class="btn small" id="addFam">+ Aggiungi famiglia</button>
      <span class="pill">D • L • H • Sp • Mat • Fin • Tok</span>
    </div>
    <table>
      <thead>
        <tr>
          <th style="width:120px">Codice</th>
          <th>Descrizione</th>
          <th style="width:60px">D</th>
          <th style="width:60px">L</th>
          <th style="width:60px">H</th>
          <th style="width:60px">Sp</th>
          <th style="width:70px">Mat</th>
          <th style="width:70px">Fin</th>
          <th style="width:70px">Tok</th>
          <th style="width:120px">Azioni</th>
        </tr>
      </thead>
      <tbody id="tbodyFam"></tbody>
    </table>
    <div class="note">Abilita le colonne rilevanti per ogni famiglia.</div>
  </section>

  <!-- Materiali -->
  <section class="panel hidden" id="view-materiali">
    <div class="grid-actions">
      <button class="btn small" id="addMat">+ Aggiungi materiale</button>
      <span class="pill">Esempi: S235, S355, AISI 304</span>
    </div>
    <table>
      <thead>
        <tr><th style="width:120px">Codice</th><th>Descrizione</th><th style="width:120px">Azioni</th></tr>
      </thead>
      <tbody id="tbodyMat"></tbody>
    </table>
  </section>

  <!-- Finiture -->
  <section class="panel hidden" id="view-finiture">
    <div class="grid-actions">
      <button class="btn small" id="addFin">+ Aggiungi finitura</button>
      <span class="pill">Esempi: GREZ, VERN, ZINC</span>
    </div>
    <table>
      <thead>
        <tr><th style="width:120px">Codice</th><th>Descrizione</th><th style="width:120px">Azioni</th></tr>
      </thead>
      <tbody id="tbodyFin"></tbody>
    </table>
  </section>

  <!-- Tipi -->
  <section class="panel hidden" id="view-tipi">
    <div class="grid-actions">
      <button class="btn small" id="addTip">+ Aggiungi tipo</button>
      <span class="pill">Esempi: TUB, LAM, STA</span>
    </div>
    <table>
      <thead>
        <tr><th style="width:120px">Codice</th><th>Descrizione</th><th style="width:120px">Azioni</th></tr>
      </thead>
      <tbody id="tbodyTip"></tbody>
    </table>
  </section>

  <div class="footer-note" id="statusMsg">Pronto.</div>
</main>

<script>
(() => {
  // ---------- Config ----------
  const STORAGE_KEYS = [
    'scm.catalogs.override',
    'scm:catalogsOverride',
    'scm_override_catalogs',
    'ShortCodeMakerV4.catalogsOverride'
  ];
  const DEFAULT_PATHS = {
     famiglie:'assets/data/famiglie.json',
     materiali:'assets/data/materiali.json',
     finiture:'assets/data/finiture.json',
     tipi:'assets/data/tipi.json',
  };

  // ---------- State ----------
  let data = {famiglie:[], materiali:[], finiture:[], tipi:[]}; // formato interno (useD/hasMaterial…)

  // ---------- Helpers ----------
  const $ = s => document.querySelector(s);
  const el = (t,p={}) => Object.assign(document.createElement(t), p);
  const setStatus = (m,cls='') => { const n=$('#statusMsg'); n.className='footer-note '+cls; n.textContent=m; };
  const toBool = v => !!(v===true || v==='true' || v===1 || v==='1');

  // Canonico ⇄ Interno
  const canonFromAny = f => ({
    code:(f.code||'').trim().toUpperCase(),
    label:f.label||'',
    D:toBool(f.D ?? f.useD ?? f.d),
    L:toBool(f.L ?? f.useL ?? f.l),
    H:toBool(f.H ?? f.useH ?? f.h),
    Sp:toBool(f.Sp ?? f.useSp ?? f.sp),
    mat:toBool(f.mat ?? f.hasMaterial ?? f.material),
    fin:toBool(f.fin ?? f.hasFinish ?? f.finish),
    tok:toBool(f.tok ?? f.useTokens ?? f.tokens)
  });
  const internalFromCanon = f => ({
    code:f.code, label:f.label,
    useD:f.D, useL:f.L, useH:f.H, useSp:f.Sp,
    hasMaterial:f.mat, hasFinish:f.fin, useTokens:f.tok
  });
  const canonizeAll = obj => ({
    famiglie: (obj.famiglie||[]).map(canonFromAny),
    materiali: (obj.materiali||[]).map(x=>({code:(x.code||'').trim().toUpperCase(),label:x.label||''})),
    finiture:  (obj.finiture ||[]).map(x=>({code:(x.code||'').trim().toUpperCase(),label:x.label||''})),
    tipi:      (obj.tipi     ||[]).map(x=>({code:(x.code||'').trim().toUpperCase(),label:x.label||''})),
  });
  const toInternal = canon => ({
    famiglie: (canon.famiglie||[]).map(internalFromCanon),
    materiali: canon.materiali||[],
    finiture:  canon.finiture ||[],
    tipi:      canon.tipi     ||[],
  });

  // Storage
  function loadFromLocalStorage(){
    for(const k of STORAGE_KEYS){
      const raw = localStorage.getItem(k);
      if(!raw) continue;
      try{
        const parsed = JSON.parse(raw);
        if(parsed && parsed.famiglie && parsed.materiali && parsed.finiture && parsed.tipi){
          return canonizeAll(parsed); // normalizza chiavi vecchie
        }
      }catch(e){}
    }
    return null;
  }
  function saveToLocalStorage(canonical){
    const raw = JSON.stringify(canonical);
    for(const k of STORAGE_KEYS){ localStorage.setItem(k, raw); }
  }
  function removeOverrides(){ for(const k of STORAGE_KEYS){ localStorage.removeItem(k);} }

  async function loadDefaults(){
    const [fam,mat,fin,tip] = await Promise.all([
      fetch(DEFAULT_PATHS.famiglie).then(r=>r.json()),
      fetch(DEFAULT_PATHS.materiali).then(r=>r.json()),
      fetch(DEFAULT_PATHS.finiture).then(r=>r.json()),
      fetch(DEFAULT_PATHS.tipi).then(r=>r.json()),
    ]);
    return canonizeAll({famiglie:fam,materiali:mat,finiture:fin,tipi:tip});
  }

  // UI render
  function renderAll(){
    renderFamiglie();
    renderSimple('materiali', $('#tbodyMat'), buildSimpleRow);
    renderSimple('finiture',  $('#tbodyFin'), buildSimpleRow);
    renderSimple('tipi',      $('#tbodyTip'), buildSimpleRow);
  }
  function renderFamiglie(){
    const tb = $('#tbodyFam'); tb.innerHTML='';
    data.famiglie.forEach((row,idx)=>tb.appendChild(buildFamRow(row,idx)));
  }
  function buildFamRow(row, idx){
    const tr = el('tr');

    const tdCode = el('td');
    const inCode = el('input',{type:'text',value:row.code});
    inCode.addEventListener('input',()=> row.code = inCode.value.trim().toUpperCase());
    tdCode.appendChild(inCode);

    const tdLabel = el('td');
    const inLabel = el('input',{type:'text',value:row.label});
    inLabel.addEventListener('input',()=> row.label = inLabel.value);
    tdLabel.appendChild(inLabel);

    const mk = (prop)=>{ const td=el('td'); const c=el('input',{type:'checkbox',checked:!!row[prop]}); c.onchange=()=>row[prop]=c.checked; td.appendChild(c); return td; }

    const tdAct = el('td');
    const del = el('button',{className:'btn small danger',textContent:'Elimina'});
    del.onclick=()=>{ if(confirm('Eliminare la famiglia?')){ data.famiglie.splice(idx,1); renderFamiglie(); } };
    tdAct.appendChild(el('div',{className:'row-actions'})).appendChild(del);

    tr.append(tdCode, tdLabel, mk('useD'), mk('useL'), mk('useH'), mk('useSp'), mk('hasMaterial'), mk('hasFinish'), mk('useTokens'), tdAct);
    return tr;
  }
  function renderSimple(key, tb, builder){
    tb.innerHTML=''; data[key].forEach((row,idx)=>tb.appendChild(builder(key,row,idx)));
  }
  function buildSimpleRow(key,row,idx){
    const tr = el('tr');

    const tdCode = el('td');
    const inCode = el('input',{type:'text',value:row.code||''});
    inCode.oninput=()=> row.code=inCode.value.trim().toUpperCase();
    tdCode.appendChild(inCode);

    const tdLabel = el('td');
    const inLabel = el('input',{type:'text',value:row.label||''});
    inLabel.oninput=()=> row.label=inLabel.value;
    tdLabel.appendChild(inLabel);

    const tdAct = el('td');
    const del = el('button',{className:'btn small danger',textContent:'Elimina'});
    del.onclick=()=>{ if(confirm('Eliminare la riga?')){ data[key].splice(idx,1); renderSimple(key, document.querySelector(key==='materiali'?'#tbodyMat':key==='finiture'?'#tbodyFin':'#tbodyTip'), buildSimpleRow); } };
    tdAct.appendChild(el('div',{className:'row-actions'})).appendChild(del);

    tr.append(tdCode,tdLabel,tdAct);
    return tr;
  }

  // Buttons
  $('#addFam').onclick=()=>{ data.famiglie.push({code:'',label:'',useD:false,useL:false,useH:false,useSp:false,hasMaterial:false,hasFinish:false,useTokens:false}); renderFamiglie(); };
  $('#addMat').onclick=()=>{ data.materiali.push({code:'',label:''}); renderSimple('materiali',$('#tbodyMat'),buildSimpleRow); };
  $('#addFin').onclick=()=>{ data.finiture.push({code:'',label:''}); renderSimple('finiture',$('#tbodyFin'),buildSimpleRow); };
  $('#addTip').onclick=()=>{ data.tipi.push({code:'',label:''}); renderSimple('tipi',$('#tbodyTip'),buildSimpleRow); };

  function toCanonicalFromInternal(){
    return {
      famiglie: data.famiglie.map(f=>canonFromAny({
        code:f.code,label:f.label,D:f.useD,L:f.useL,H:f.useH,Sp:f.useSp,mat:f.hasMaterial,fin:f.hasFinish,tok:f.useTokens
      })),
      materiali: data.materiali,
      finiture:  data.finiture,
      tipi:      data.tipi
    };
  }

  $('#btnSave').onclick=()=>{ const canonical = toCanonicalFromInternal(); saveToLocalStorage(canonical); setStatus('Dati salvati in browser (override attivo).','ok'); };
  $('#btnRemove').onclick=()=>{ if(confirm('Rimuovere l’override locale?')){ removeOverrides(); setStatus('Override rimosso. Ricarica per usare i default.'); } };
  $('#btnReset').onclick=async()=>{ if(!confirm('Ripristinare i default dai file in assets/data/?')) return; const canon = await loadDefaults(); saveToLocalStorage(canon); data = toInternal(canon); renderAll(); setStatus('Default caricati e salvati in locale.'); };
  $('#btnExport').onclick=()=>{ const a=document.createElement('a'); const content=JSON.stringify(toCanonicalFromInternal(),null,2); a.href=URL.createObjectURL(new Blob([content],{type:'application/json'})); a.download='cataloghi_scm_v4.json'; a.click(); URL.revokeObjectURL(a.href); setStatus('File JSON esportato.'); };
  $('#btnValidate').onclick=()=>{ const c=toCanonicalFromInternal(); const probs=[]; const chk=(arr,name)=>{ const seen=new Set(); for(const x of arr){ if(!x.code||!x.label) probs.push(`${name}: codice/descrizione mancanti`); if(seen.has(x.code)) probs.push(`${name}: codice duplicato ${x.code}`); seen.add(x.code);} }; chk(c.famiglie,'Famiglie'); chk(c.materiali,'Materiali'); chk(c.finiture,'Finiture'); chk(c.tipi,'Tipi'); if(probs.length){ alert('Problemi:\\n - '+probs.join('\\n - ')); setStatus('Validazione: errori trovati.'); } else { setStatus('Validazione OK.'); } };

  $('#fileImport').onchange=async ev=>{
    const file=ev.target.files?.[0]; if(!file) return;
    try{
      const obj = JSON.parse(await file.text());
      const canon = canonizeAll(obj);        // accetta anche formati vecchi
      saveToLocalStorage(canon);             // persiste canonico
      data = toInternal(canon);              // mostra interno
      renderAll();
      setStatus('Dati importati e salvati in locale.');
    }catch(e){ alert('Import fallito: '+e.message); setStatus('Import fallito.'); }
    ev.target.value='';
  };

  // Tabs
  document.querySelectorAll('.tab').forEach(t=>{
    t.onclick=()=>{ document.querySelectorAll('.tab').forEach(x=>x.classList.remove('active')); t.classList.add('active');
      document.querySelectorAll('section.panel').forEach(s=>s.classList.add('hidden'));
      document.querySelector('#view-'+t.dataset.tab).classList.remove('hidden'); };
  });

  // Boot
  (async function init(){
    setStatus('Inizializzazione…');
    const ls = loadFromLocalStorage();
    if(ls){ data = toInternal(ls); setStatus('Caricati dati da browser (override attivo).'); }
    else { try{ const canon = await loadDefaults(); data = toInternal(canon); setStatus('Caricati default da assets/data/.'); } catch(e){ console.error(e); setStatus('Errore nel caricamento dei default. Verifica assets/data/.'); } }
    renderAll();
  })();
})();
</script>
</body>
</html>
