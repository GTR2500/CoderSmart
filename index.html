<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <title>ShortCode Maker v4 — Grimaldelli</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    :root{ --bg:#0f1115; --panel:#111827; --panel2:#0f1623; --line:#2a2f3a; --text:#e6e6e6; }
    *{box-sizing:border-box;font-family:system-ui,-apple-system,"Segoe UI",Roboto,Arial,sans-serif}
    body{margin:0;background:var(--bg);color:var(--text)}
    header{position:sticky;top:0;background:#0f131a;border-bottom:1px solid var(--line)}
    .bar{max-width:1200px;margin:0 auto;padding:14px 20px;display:flex;gap:12px;align-items:center}
    h1{font-size:18px;margin:0}
    nav{margin-left:auto;display:flex;gap:8px}
    nav a{color:#cbd5e1;text-decoration:none;background:#111827;border:1px solid #2a2f3a;padding:6px 10px;border-radius:8px}
    nav a.active{border-color:#3b82f6;box-shadow:0 0 0 1px #3b82f6 inset}
    main{max-width:1200px;margin:0 auto;padding:20px}
    .card{background:#111827;border:1px solid #2a2f3a;border-radius:12px;padding:14px;margin-bottom:16px}
    .row{display:grid;gap:12px}
    .grid-3{grid-template-columns:1fr 1fr 1fr}
    .grid-4{grid-template-columns:1fr 1fr 1fr 1fr}
    label{font-size:13px;color:#cbd5e1}
    select, input[type="text"], input[type="number"]{width:100%;background:#0b1220;border:1px solid #233047;color:#e5e7eb;border-radius:8px;padding:8px 10px}
    .checks{display:flex;gap:10px;flex-wrap:wrap}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0b1220;border:1px solid #2a2f3a;padding:8px 10px;border-radius:999px}
    .btn{background:#111827;border:1px solid #2a2f3a;color:#e5e7eb;padding:8px 12px;border-radius:10px;cursor:pointer}
    .copyrow{display:grid;grid-template-columns:1fr 90px;gap:8px}
  </style>
</head>
<body>
<header>
  <div class="bar">
    <h1>ShortCode Maker v4 — Grimaldelli</h1>
    <nav>
      <a class="active" href="index.html">Generatore</a>
      <a href="istruzioni.html">Istruzioni</a>
      <a href="dati.html">Dati</a>
      <a href="tipi.html">Config. Tipi</a>
    </nav>
  </div>
</header>

<main>
  <section class="card">
    <h3>Cataloghi (per i menu a discesa)</h3>
    <div class="row grid-3">
      <div>
        <label>Famiglia</label>
        <select id="selFamiglia" data-catalog="famiglie"></select>
      </div>
      <div>
        <label>Materiale</label>
        <select id="selMateriale" data-catalog="materiali"></select>
      </div>
      <div>
        <label>Finitura</label>
        <select id="selFinitura" data-catalog="finiture"></select>
      </div>
    </div>
    <div class="pill" style="margin-top:8px">Le liste si modificano dalla pagina <a href="dati.html" style="color:#93c5fd">Dati</a>.</div>
  </section>

  <section class="card">
    <h3>Composizione ShortCode (seleziona cosa includere)</h3>
    <div class="checks">
      <label><input type="checkbox" id="chkFam" checked disabled /> Famiglia</label>
      <label><input type="checkbox" id="chkTipo" checked /> Tipo</label>
      <label><input type="checkbox" id="chkD" /> Ø D</label>
      <label><input type="checkbox" id="chkL" /> L</label>
      <label><input type="checkbox" id="chkH" /> H</label>
      <label><input type="checkbox" id="chkSp" /> Spessore</label>
      <label><input type="checkbox" id="chkMat" /> Materiale</label>
      <label><input type="checkbox" id="chkFin" /> Finitura</label>
      <label><input type="checkbox" id="chkTok" /> Token</label>
    </div>
    <div class="pill" style="margin-top:8px">Struttura v4: <b>FAM-TIPO-D3-L4-H4-S3-MAT-FIN-TOK</b>. I campi non inclusi diventano <b>000</b>.</div>
  </section>

  <section class="card">
    <h3>Attributi</h3>
    <div class="row grid-4">
      <div>
        <label>Tipo Prodotto</label>
        <select id="selTipo"></select>
      </div>
      <div>
        <label>Ø D [mm]</label>
        <input id="inpD" type="number" min="0" max="999" value="0" />
      </div>
      <div>
        <label>L [mm]</label>
        <input id="inpL" type="number" min="0" max="9999" value="0" />
      </div>
      <div>
        <label>H [mm]</label>
        <input id="inpH" type="number" min="0" max="9999" value="0" />
      </div>
    </div>
    <div class="row grid-4" style="margin-top:12px">
      <div>
        <label>Spessore [mm]</label>
        <input id="inpSp" type="number" min="0" max="999" value="0" />
      </div>
      <div>
        <label>Token (DX/SN/ALTRO, max 5)</label>
        <input id="inpTok" type="text" maxlength="5" />
      </div>
    </div>
  </section>

  <section class="card">
    <h3>Output</h3>
    <div class="copyrow"><input id="outCode" type="text" readonly /><button class="btn" data-copy="#outCode">Copia</button></div>
    <div class="copyrow"><input id="outFolder" type="text" placeholder="Nome cartella (auto)" readonly /><button class="btn" data-copy="#outFolder">Copia</button></div>
    <div class="copyrow"><input id="outFile" type="text" placeholder="Nome file (auto)" readonly /><button class="btn" data-copy="#outFile">Copia</button></div>
    <div class="copyrow"><input id="outDesc" type="text" placeholder="Descrizione (auto)" readonly /><button class="btn" data-copy="#outDesc">Copia</button></div>
  </section>
</main>

<script type="module">
import { loadCatalogs } from './assets/data/loader.js';  // << path corretto

const pad = (n, w)=> String(Math.max(0, +n|0)).padStart(w,'0');
const $ = s => document.querySelector(s);

let catalogs = {famiglie:[],materiali:[],finiture:[],tipi:[]};
let famSel = null;

function fillSelect(sel, items){
  sel.innerHTML = '<option value=""></option>' + items.map(x=>`<option value="${x.code}">${x.code} — ${x.label}</option>`).join('');
}
function fillSimple(sel, items){
  sel.innerHTML = '<option value=""></option>' + items.map(x=>`<option value="${x.code}">${x.code} — ${x.label}</option>`).join('');
}

function applyFamFlags(){
  const fcode = $('#selFamiglia').value;
  famSel = catalogs.famiglie.find(f=>f.code===fcode) || null;
  const flags = famSel || {D:false,L:false,H:false,Sp:false,mat:false,fin:false,tok:false};
  $('#chkD').disabled = !flags.D; if(!flags.D) $('#chkD').checked=false;
  $('#chkL').disabled = !flags.L; if(!flags.L) $('#chkL').checked=false;
  $('#chkH').disabled = !flags.H; if(!flags.H) $('#chkH').checked=false;
  $('#chkSp').disabled= !flags.Sp; if(!flags.Sp) $('#chkSp').checked=false;
  $('#chkMat').disabled=!flags.mat; if(!flags.mat) $('#chkMat').checked=false;
  $('#chkFin').disabled=!flags.fin; if(!flags.fin) $('#chkFin').checked=false;
  $('#chkTok').disabled=!flags.tok; if(!flags.tok) $('#chkTok').checked=false;
  render();
}

function render(){
  const fam = $('#selFamiglia').value || '';
  const tipo = $('#selTipo').value || '';
  const inc = {
    fam:true,
    tipo: $('#chkTipo').checked,
    D:   $('#chkD').checked,
    L:   $('#chkL').checked,
    H:   $('#chkH').checked,
    Sp:  $('#chkSp').checked,
    mat: $('#chkMat').checked,
    fin: $('#chkFin').checked,
    tok: $('#chkTok').checked,
  };
  const vals = {
    D: pad($('#inpD').value,3),
    L: pad($('#inpL').value,4),
    H: pad($('#inpH').value,4),
    Sp: pad($('#inpSp').value,3),
    mat: $('#selMateriale').value || '000',
    fin: $('#selFinitura').value || '000',
    tok: ($('#inpTok').value || '').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,5) || '000'
  };

  const parts = [];
  parts.push(fam || '---');
  parts.push(inc.tipo ? (tipo || '---') : '000');
  parts.push(inc.D   ? `D${vals.D}` : '000');
  parts.push(inc.L   ? `L${vals.L}` : '000');
  parts.push(inc.H   ? `H${vals.H}` : '000');
  parts.push(inc.Sp  ? `S${vals.Sp}`: '000');
  parts.push(inc.mat ? vals.mat     : '000');
  parts.push(inc.fin ? vals.fin     : '000');
  parts.push(inc.tok ? vals.tok     : '000');

  const code = parts.join('-');
  $('#outCode').value = code;
  $('#outFolder').value = fam ? `${fam}` : '';
  $('#outFile').value   = code + '.pdf';
  const famLabel = famSel ? famSel.label : '';
  const tipoLabel = (catalogs.tipi.find(t=>t.code===$('#selTipo').value)||{}).label || '';
  $('#outDesc').value = [famLabel, tipoLabel].filter(Boolean).join(' — ');
}

function attach(){
  document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', render));
  $('#selFamiglia').addEventListener('change', applyFamFlags);
  document.querySelectorAll('[data-copy]').forEach(b=>{
    b.addEventListener('click', ()=>{
      const inp = document.querySelector(b.getAttribute('data-copy'));
      inp.select(); document.execCommand('copy');
    });
  });
  window.addEventListener('storage', (e) => {
    if (['scm.catalogs.override','scm:catalogsOverride','scm_override_catalogs','ShortCodeMakerV4.catalogsOverride'].includes(e.key)) {
      init();
    }
  });
}

async function init(){
  catalogs = await loadCatalogs();
  fillSelect($('#selFamiglia'), catalogs.famiglie);
  fillSimple($('#selMateriale'), catalogs.materiali);
  fillSimple($('#selFinitura'), catalogs.finiture);
  fillSimple($('#selTipo'), catalogs.tipi);
  applyFamFlags();
}

attach();
init();
</script>
</body>
</html>
