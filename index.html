<!doctype html>
<html lang="it">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>Tecnical Coder</title>
  <link rel="stylesheet" href="assets/styles.css" />
  <style>
    /* supporto al mini selettore vicino a D */
    .inline{display:flex; gap:8px; align-items:center}
    .mini{
      min-width:56px;
      padding:6px 8px;
      border:1px solid var(--line);
      background:var(--panel);
      color:var(--text);
      border-radius:10px;
      height:36px;
    }
    main{max-width:1200px;margin:0 auto;padding:20px}
  </style>
</head>
<body>

  <!-- ===== HEADER ===== -->
  <header class="app-header">
    <a class="brand" href="https://www.glcgrimaldelli.com" target="_blank" rel="noopener">
      <img class="brand-logo" src="https://www.glcgrimaldelli.com/wp-content/uploads/2019/06/Logo-Sottopagine.jpg" alt="Grimaldelli s.r.l." />
    </a>

    <h1 class="brand-title">Tecnical Coder</h1>

    <!-- Badge versione + toggle tema -->
    <div id="buildBadge" class="build-badge" title="Ultimo aggiornamento"></div>
    <button id="themeToggle" class="theme-toggle" title="Cambia tema">
      <!-- Sole -->
      <svg class="icon-sun" viewBox="0 0 24 24" fill="none" stroke="currentColor"><circle cx="12" cy="12" r="4"/><path d="M12 2v2m0 16v2M4.93 4.93l1.41 1.41M17.66 17.66l1.41 1.41M2 12h2m16 0h2M4.93 19.07l1.41-1.41M17.66 6.34l1.41-1.41"/></svg>
      <!-- Luna -->
      <svg class="icon-moon" viewBox="0 0 24 24" fill="currentColor"><path d="M21 12.79A9 9 0 1 1 11.21 3 7 7 0 0 0 21 12.79z"/></svg>
    </button>
  </header>

  <!-- ===== NAV ===== -->
  <div class="subnav">
    <div class="bar">
      <nav>
        <a class="active" href="index.html">Generatore</a>
        <a href="istruzioni.html">Istruzioni</a>
        <a href="dati.html">Dati</a>
      </nav>
    </div>
  </div>

  <!-- ===== MAIN ===== -->
  <main>
    <section class="card">
      <h3>Cataloghi (per i menu a discesa)</h3>
      <div class="row grid-3">
        <div>
          <label>Famiglia</label>
          <select id="selFamiglia" data-catalog="famiglie"></select>
        </div>
        <div>
          <label>Materiale</label>
          <select id="selMateriale" data-catalog="materiali"></select>
        </div>
        <div>
          <label>Finitura</label>
          <select id="selFinitura" data-catalog="finiture"></select>
        </div>
      </div>
      <div class="pill" style="margin-top:8px">Le liste si modificano dalla pagina <a href="dati.html">Dati</a>.</div>
    </section>

    <section class="card">
      <h3>Composizione ShortCode (seleziona cosa includere)</h3>
      <div class="checks">
        <label><input type="checkbox" id="chkFam" checked disabled /> Famiglia</label>
        <label><input type="checkbox" id="chkTipo" checked /> Tipo</label>
        <label><input type="checkbox" id="chkD" /> Ø D</label>
        <label><input type="checkbox" id="chkL" /> L</label>
        <label><input type="checkbox" id="chkH" /> H</label>
        <label><input type="checkbox" id="chkSp" /> Spessore</label>
        <label><input type="checkbox" id="chkMat" /> Materiale</label>
        <label><input type="checkbox" id="chkFin" /> Finitura</label>
        <label><input type="checkbox" id="chkTok" /> Token</label>
      </div>
      <div class="pill" style="margin-top:8px">Struttura v4: <b>FAM-TIPO-D3-L4-H4-S3-MAT-FIN-TOK</b>. I campi non inclusi diventano <b>000</b>.</div>
    </section>

    <section class="card">
      <h3>Attributi</h3>
      <div class="row grid-4">
        <div>
          <label>Tipo Prodotto</label>
          <select id="selTipo"></select>
        </div>
        <div>
          <label>Misura D [mm]</label>
          <div class="inline">
            <select id="dLabel" class="mini" title="Prefisso in descrizione (Ø oppure A)">
              <option value="Ø" selected>Ø</option>
              <option value="A">A</option>
            </select>
            <input id="inpD" type="number" min="0" max="999" value="0" />
          </div>
        </div>
        <div>
          <label>L [mm]</label>
          <input id="inpL" type="number" min="0" max="9999" value="0" />
        </div>
        <div>
          <label>H [mm]</label>
          <input id="inpH" type="number" min="0" max="9999" value="0" />
        </div>
      </div>
      <div class="row grid-4" style="margin-top:12px">
        <div>
          <label>Spessore [mm]</label>
          <input id="inpSp" type="number" min="0" max="999" value="0" />
        </div>
        <div>
          <label>Token (DX/SN/ALTRO, max 5)</label>
          <input id="inpTok" type="text" maxlength="5" />
        </div>
      </div>
    </section>

    <section class="card">
      <h3>Output</h3>
      <div class="copyrow">
        <div>
          <label>ShortCode (auto)</label>
          <input id="outCode" type="text" readonly />
        </div>
        <button class="btn" data-copy="#outCode">Copia</button>
      </div>
      <div class="copyrow">
        <div>
          <label>Descrizione (auto: etichette complete)</label>
          <input id="outDesc" type="text" readonly />
        </div>
        <button class="btn" data-copy="#outDesc">Copia</button>
      </div>
      <div class="copyrow">
        <div>
          <label>Nome cartella (auto)</label>
          <input id="outFolder" type="text" readonly />
        </div>
        <button class="btn" data-copy="#outFolder">Copia</button>
      </div>
    </section>
  </main>

  <!-- ===== FOOTER ===== -->
  <footer class="app-footer">
    <div class="footer-inner">
      <span class="product">&copy; Tecnical Coder</span>
      <span class="for"> per Grimaldelli s.r.l.</span>
      <span class="sep"> — </span>
      <span class="signature">Manuel Zago</span>
    </div>
  </footer>

  <!-- ===== SCRIPT ===== -->
  <script>
    /* ===== Tema chiaro/scuro ===== */
    const THEME_KEY='tc.theme';
    const setTheme = t => document.documentElement.setAttribute('data-theme', t);
    (function(){ setTheme(localStorage.getItem(THEME_KEY) || 'dark'); })();
    document.getElementById('themeToggle').addEventListener('click', ()=>{
      const curr = document.documentElement.getAttribute('data-theme')==='light'?'light':'dark';
      const next = curr==='light' ? 'dark' : 'light';
      setTheme(next); localStorage.setItem(THEME_KEY, next);
    });

    /* ===== Badge versione auto da GitHub + click per aggiornare ===== */
    function guessRepo(){
      const host = location.hostname;                 // es. gtr2500.github.io
      const owner = host.split('.')[0];               // gtr2500
      const path = location.pathname.split('/').filter(Boolean);
      const repo  = path[0] || 'CoderSmart';          // cartella progetto pages
      const branch = 'main';
      return { owner, repo, branch };
    }
    const OV_KEYS = [
      'scm.catalogs.override','scm:catalogsOverride',
      'scm_override_catalogs','ShortCodeMakerV4.catalogsOverride'
    ];
    function clearLocalOverrides(){ OV_KEYS.forEach(k=>localStorage.removeItem(k)); }
    async function clearHttpCaches(){
      if(!('caches' in window)) return;
      const keys = await caches.keys();
      await Promise.all(keys.map(k=>caches.delete(k)));
    }
    async function loadVersionBadge(){
      const badge = document.getElementById('buildBadge');
      if(!badge) return;
      badge.textContent = 'Verifica aggiornamenti…';
      try{
        const {owner, repo, branch} = guessRepo();
        const url = `https://api.github.com/repos/${owner}/${repo}/commits?sha=${branch}&per_page=1`;
        const resp = await fetch(url, {headers:{'Accept':'application/vnd.github+json'}});
        if(resp.ok){
          const arr = await resp.json();
          if(Array.isArray(arr) && arr.length){
            const sha = (arr[0].sha||'').slice(0,7);
            const iso = arr[0].commit?.committer?.date || arr[0].commit?.author?.date || new Date().toISOString();
            const d   = new Date(iso);
            const dataIT = d.toLocaleDateString('it-IT');
            const oraIT  = d.toLocaleTimeString('it-IT',{hour:'2-digit',minute:'2-digit'});
            const version = `${d.getFullYear()}${String(d.getMonth()+1).padStart(2,'0')}${String(d.getDate()).padStart(2,'0')}-${sha}`;
            badge.textContent = `Ultimo agg.: ${dataIT} ${oraIT} • ${sha}`;
            badge.dataset.version = version;
            badge.addEventListener('click', async ()=>{
              const ok = confirm('Aggiornare alla versione più recente?\nQuesto cancellerà i dati salvati in locale (override) e pulirà la cache.\nProcedere?');
              if(!ok) return;
              try{ clearLocalOverrides(); await clearHttpCaches(); }catch(e){}
              const v = badge.dataset.version || Date.now();
              const base = location.pathname.split('?')[0];
              const qs = location.search && !location.search.includes('v=') ? location.search + '&' : '?';
              location.replace(base + qs + 'v=' + v);
            });
            return;
          }
        }
      }catch(e){}
      // fallback
      badge.textContent = 'Ultimo agg.: ' + new Date(document.lastModified).toLocaleString('it-IT');
    }
    loadVersionBadge();

    /* ===== Generatore ===== */

    // 1) Cataloghi (override locale oppure file assets/data)
    const STORAGE_KEYS = [
      'scm.catalogs.override','scm:catalogsOverride','scm_override_catalogs','ShortCodeMakerV4.catalogsOverride'
    ];
    const PATHS = {
      famiglie:'assets/data/famiglie.json',
      materiali:'assets/data/materiali.json',
      finiture:'assets/data/finiture.json',
      tipi:'assets/data/tipi.json'
    };
    const toBool = v => !!(v===true||v==='true'||v===1||v==='1');
    const canonFam = x => ({
      code:(x.code||'').trim().toUpperCase(),
      label:x.label||'',
      D:toBool(x.D??x.useD??x.d),
      L:toBool(x.L??x.useL??x.l),
      H:toBool(x.H??x.useH??x.h),
      Sp:toBool(x.Sp??x.useSp??x.sp),
      mat:toBool(x.mat??x.hasMaterial??x.material),
      fin:toBool(x.fin??x.hasFinish??x.finish),
      tok:toBool(x.tok??x.useTokens??x.tokens)
    });
    const canonSimple = x => ({code:(x.code||'').trim().toUpperCase(),label:x.label||''});
    function canonize(obj){
      return {
        famiglie:(obj.famiglie||[]).map(canonFam),
        materiali:(obj.materiali||[]).map(canonSimple),
        finiture:(obj.finiture||[]).map(canonSimple),
        tipi:(obj.tipi||[]).map(canonSimple)
      };
    }
    function readLS(){
      for(const k of STORAGE_KEYS){
        const raw=localStorage.getItem(k);
        if(!raw) continue;
        try{
          const j=JSON.parse(raw);
          if(j && j.famiglie && j.materiali && j.finiture && j.tipi) return canonize(j);
        }catch(e){}
      }
      return null;
    }
    async function loadCatalogs(){
      const fromLS = readLS();
      if(fromLS) return fromLS;
      const [fam,mat,fin,tip] = await Promise.all([
        fetch(PATHS.famiglie).then(r=>r.json()),
        fetch(PATHS.materiali).then(r=>r.json()),
        fetch(PATHS.finiture).then(r=>r.json()),
        fetch(PATHS.tipi).then(r=>r.json())
      ]);
      return canonize({famiglie:fam,materiali:mat,finiture:fin,tipi:tip});
    }

    // 2) Utility UI
    const $ = s => document.querySelector(s);
    const pad = (n, w)=> String(Math.max(0, +n|0)).padStart(w,'0');
    function dPrefix(){ return (document.getElementById('dLabel')?.value || 'Ø'); }

    let catalogs = {famiglie:[],materiali:[],finiture:[],tipi:[]};
    let famSel = null;

    function fillSelect(sel, items){
      sel.innerHTML = '<option value=""></option>' +
        items.map(x=>`<option value="${x.code}">${x.code} — ${x.label}</option>`).join('');
    }

    function applyFamFlags(){
      const fcode = $('#selFamiglia').value;
      famSel = catalogs.famiglie.find(f=>f.code===fcode) || null;
      const flags = famSel || {D:false,L:false,H:false,Sp:false,mat:false,fin:false,tok:false};

      $('#chkD').disabled=!flags.D; if(!flags.D) $('#chkD').checked=false;
      $('#chkL').disabled=!flags.L; if(!flags.L) $('#chkL').checked=false;
      $('#chkH').disabled=!flags.H; if(!flags.H) $('#chkH').checked=false;
      $('#chkSp').disabled=!flags.Sp; if(!flags.Sp) $('#chkSp').checked=false;
      $('#chkMat').disabled=!flags.mat; if(!flags.mat) $('#chkMat').checked=false;
      $('#chkFin').disabled=!flags.fin; if(!flags.fin) $('#chkFin').checked=false;
      $('#chkTok').disabled=!flags.tok; if(!flags.tok) $('#chkTok').checked=false;

      render();
    }

    // Descrizione compatta: Famiglia (label) + TIPO (sigla) + Ø/L/H/Sp + Materiale (sigla) + Finitura (sigla) + Token (valore)
    function makeDescriptionCompact(inc){
      const parts = [];
      if (famSel && famSel.label) parts.push(famSel.label);
      const tipoCode = ($('#selTipo').value || '').trim().toUpperCase();
      if (inc.tipo && tipoCode) parts.push(tipoCode);

      const Dv = +$('#inpD').value || 0;
      const Lv = +$('#inpL').value || 0;
      const Hv = +$('#inpH').value || 0;
      const Sv = +$('#inpSp').value || 0;

      if (inc.D  && Dv>0) parts.push(dPrefix(), String(Dv));
      if (inc.L  && Lv>0) parts.push('L', String(Lv));
      if (inc.H  && Hv>0) parts.push('H', String(Hv));
      if (inc.Sp && Sv>0) parts.push('Sp', String(Sv), 'mm');

      const matCode = ($('#selMateriale').value || '').trim().toUpperCase();
      const finCode = ($('#selFinitura').value  || '').trim().toUpperCase();
      if (inc.mat && matCode) parts.push(matCode);
      if (inc.fin && finCode) parts.push(finCode);

      const tokVal = ($('#inpTok').value || '').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,5);
      if (inc.tok && tokVal) parts.push(tokVal);

      return parts.join(' ').replace(/\s+/g,' ').trim();
    }

    // 3) Render ShortCode + Descrizione + Nome cartella
    function render(){
      const fam  = $('#selFamiglia').value || '';
      const tipo = $('#selTipo').value || '';

      const inc = {
        fam:true,
        tipo: $('#chkTipo').checked,
        D:    $('#chkD').checked,
        L:    $('#chkL').checked,
        H:    $('#chkH').checked,
        Sp:   $('#chkSp').checked,
        mat:  $('#chkMat').checked,
        fin:  $('#chkFin').checked,
        tok:  $('#chkTok').checked,
      };

      const vals = {
        D: pad($('#inpD').value,3),
        L: pad($('#inpL').value,4),
        H: pad($('#inpH').value,4),
        Sp: pad($('#inpSp').value,3),
        mat: $('#selMateriale').value || '000',
        fin: $('#selFinitura').value  || '000',
        tok: ($('#inpTok').value || '').toUpperCase().replace(/[^A-Z0-9]/g,'').slice(0,5) || '000'
      };

      const parts = [];
      parts.push(fam || '---');
      parts.push(inc.tipo ? (tipo || '---') : '000');
      parts.push(inc.D   ? `D${vals.D}` : '000');
      parts.push(inc.L   ? `L${vals.L}` : '000');
      parts.push(inc.H   ? `H${vals.H}` : '000');
      parts.push(inc.Sp  ? `S${vals.Sp}`: '000');
      parts.push(inc.mat ? vals.mat     : '000');
      parts.push(inc.fin ? vals.fin     : '000');
      parts.push(inc.tok ? vals.tok     : '000');

      const sc = parts.join('-');
      $('#outCode').value = sc;

      const desc = makeDescriptionCompact(inc);
      $('#outDesc').value = desc;
      $('#outFolder').value = desc ? `${sc} — ${desc}` : sc;
    }

    // 4) Attach eventi
    function attach(){
      document.querySelectorAll('input,select').forEach(el=>el.addEventListener('input', render));
      document.getElementById('selFamiglia').addEventListener('change', applyFamFlags);
      document.getElementById('dLabel').addEventListener('change', render);
      document.querySelectorAll('[data-copy]').forEach(b=>{
        b.addEventListener('click', ()=>{
          const inp = document.querySelector(b.getAttribute('data-copy'));
          inp.select(); document.execCommand('copy');
        });
      });
    }

    // 5) Init
    async function init(){
      const cats = await loadCatalogs();
      catalogs = cats;
      fillSelect(document.getElementById('selFamiglia'), cats.famiglie);
      fillSelect(document.getElementById('selMateriale'), cats.materiali);
      fillSelect(document.getElementById('selFinitura'),  cats.finiture);
      fillSelect(document.getElementById('selTipo'),      cats.tipi);
      applyFamFlags();
    }

    attach(); init();
  </script>
</body>
</html>
